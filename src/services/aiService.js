const ollama = require('ollama').default;
const AI_MODEL_NAME = process.env.AI_MODEL;

exports.checkToxicity = async (text) => {
    try {
        const prompt = `
        –¢–∏ ‚Äî —Å—É–≤–æ—Ä–∏–π, –∞–ª–µ –Ω–∞–¥–∑–≤–∏—á–∞–π–Ω–æ –±—É–∫–≤–∞–ª—å–Ω–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä —Ñ–æ—Ä—É–º—É.
        –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–µ–∫—Å—Ç –í–ò–ö–õ–Æ–ß–ù–û –Ω–∞ —Ç–æ–∫—Å–∏—á–Ω—ñ—Å—Ç—å —Ç–∞ –Ω–µ–∑–≤'—è–∑–Ω—ñ—Å—Ç—å.

        **–¢–æ–±—ñ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∞–±–æ –±–ª–æ–∫—É–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ—ó "–ø—Ä–æ–≤–æ–∫–∞—Ü—ñ—ó" —á–∏ "—ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó".**

        –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è BLOCK (–ë–õ–û–ö–£–í–ê–ù–ù–Ø):
        1.  –¢–µ–∫—Å—Ç –º—ñ—Å—Ç–∏—Ç—å **–Ω–µ–ø—Ä–∏–ø—É—Å—Ç–∏–º—É –ª–µ–∫—Å–∏–∫—É** (–ª–∞–π–∫–∞, –æ–±—Ä–∞–∑–∏, –≤—É–ª—å–≥–∞—Ä–Ω–∏–π —Å–ª–µ–Ω–≥, –º–æ–≤–∞ –≤–æ—Ä–æ–∂–Ω–µ—á—ñ).
        2.  –¢–µ–∫—Å—Ç —î **–Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–∏–º, –Ω–µ–∑–≤'—è–∑–Ω–∏–º –Ω–∞–±–æ—Ä–æ–º –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤** ("!!!asdfgh123!!!").

        –£ –í–°–Ü–• –Ü–ù–®–ò–• –í–ò–ü–ê–î–ö–ê–•, —è–∫—â–æ —Ç–µ–∫—Å—Ç —î –∑—Ä–æ–∑—É–º—ñ–ª–∏–º —ñ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —Ç–æ–∫—Å–∏—á–Ω–∏—Ö —Å–ª—ñ–≤ –∑ –ø—Ä–∞–≤–∏–ª–∞ ‚Ññ1, –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π "ALLOW".

        –¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: "${text}"

        –¢–≤—ñ–π –≤–µ—Ä–¥–∏–∫—Ç (—Ç—ñ–ª—å–∫–∏ –æ–¥–Ω–µ —Å–ª–æ–≤–æ: BLOCK –∞–±–æ ALLOW.):
        `;
        const response = await ollama.chat({  
            model: 'qwen2.5:3b',
            messages: [{ role: 'user', content: prompt }],
        });
        //console.log(response);
        return response.message.content.toUpperCase().includes('ALLOW');
    } catch (error) {
        console.log("AI Error:", error);
        return false; 
    }
}

exports.analyzeTopic = async (text) => {
    try {
        const prompt = `
        –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ç–µ–∫—Å—Ç: "${text}".

        –¢–≤–æ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ü–û–í–ò–ù–ù–ê –±—É—Ç–∏ –û–î–ù–ò–ú –µ–ª–µ–º–µ–Ω—Ç–æ–º, –æ–±—Ä–∞–Ω–∏–º –∑ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É (–≤–∫–ª—é—á–Ω–æ –∑ –µ–º–æ–¥–∑—ñ):
        ["–ó–∞–ø–∏—Ç–∞–Ω–Ω—è ‚ùì", "–ü–æ–¥—è–∫–∞ üôè", "–¢–µ—Ö–Ω—ñ—á–Ω–µ üíª", "–û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è üó£Ô∏è", "–ó–Ω–∞–π–æ–º—Å—Ç–≤–æ ü§ù"]

        –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò –Ω–∞–∑–≤–æ—é –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–∞ —ó—ó –µ–º–æ–¥–∑—ñ. **–ö–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ** –¥–æ–¥–∞–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ –ø–æ—è—Å–Ω–µ–Ω–Ω—è, –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è, –≤—Å—Ç—É–ø–Ω—ñ —Ñ—Ä–∞–∑–∏ —á–∏ –∑–Ω–∞–∫–∏ –ø—É–Ω–∫—Ç—É–∞—Ü—ñ—ó.
        `;
        const response = await ollama.chat({
            model: AI_MODEL_NAME,
            messages: [{ role: 'user', content: prompt }],
        });
        return response.message.content.trim();
    } catch (error) {
        console.log(error);
        return '–û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è üó£Ô∏è';
    }
}